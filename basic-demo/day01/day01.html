<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>百度音乐排行榜</title>

    <link rel="stylesheet" href="./index.css" />
</head>
<body>
<section id="wrap">
    <h2 class="title">百度音乐榜单</h2>
    <nav class="filter"><a>已收藏</a> <a>未收藏</a> <a>默认</a></nav>
    <nav class="sort"><a>按数量从小到大</a> <a>按数量从大到小</a> <a>默认</a></nav>
    <ul id="list">
    </ul>
    <footer class="footer">
        <div class="row">
            <label><input type="checkbox" id="checkAll" />全选/全不选</label>
            <a href="javascript:;" id="delBtn">删除</a>
        </div>
        <div class="row">
            <label>名称：</label>
            <input type="text" id="name">
            <label>数量：</label>
            <input type="text" id="num">
            <a href="javascript:;" id="addBtn">添加</a>
        </div>
    </footer>
</section>
<script>
    let data = [{
        id: 0,
        txt: '青花瓷 - 周杰伦',
        checked: true,
        num: 7,
        liked: true
    }, {
        id: 1,
        txt: '泡沫 - 邓紫棋',
        checked: false,
        num: 13,
        liked: true
    }, {
        id: 2,
        txt: '爱的供养 - 杨幂',
        checked: true,
        num: 9,
        liked: false
    }];

    {
        let checkAll  = document.querySelector('#checkAll'),
            addBtn    = document.querySelector('#addBtn'),
            delBtn    = document.querySelector('#delBtn'),
            nameInput = document.querySelector('#name'),
            numInput  = document.querySelector('#num'),
            filter    = document.querySelectorAll('.filter a'),
            sort      = document.querySelectorAll('.sort a'),
            list     = document.querySelector('#list');
        let likeState = 2, sortState = 2; // 0-已收藏 1-未收藏 2-默认

        let filterFn = [
            (item) => item.liked,
            (item) => !item.liked,
            () => true
        ], sortFn = [
            (item1, item2) => item1.num - item2.num,
            (item1, item2) => item2.num - item1.num,
            () => true
        ];

        let isCheckAll = () => {return data.every(item => item.checked) && data.length > 0};

        let renderFn = () => {
            let nowData = data.filter(filterFn[likeState]).sort(sortFn[sortState]);

            list.innerHTML = nowData.map(item => `
                <li data-id="${item.id}">
                    <input class="checkbox" type="checkbox" ${item.checked ? 'checked' : ''} />
                    ${item.txt}
                    ${item.num}
                    <a href="javascript:;" class="like">${item.liked ? '取消收藏' : '收藏'}</a>
                    <a href="javascript:;" class="del">删除</a>
                </li>
            `).join('');
            checkAll.checked = isCheckAll();
            let like     = document.querySelectorAll('.like'),
                checkbox = document.querySelectorAll('.checkbox'),
                del      = document.querySelectorAll('.del');

            dealEvent(like, del, checkbox);
        };

        let dealEvent = (like, del, checkbox) => {
            like.forEach(item => {
                item.onclick = () => {
                    let parent = item.parentNode,
                        id     = parent.dataset.id;
                    data.forEach(m => {
                        if (m.id == id) {
                            m.liked = !m.liked;
                        }
                    });
                    renderFn();
                }
            });

            del.forEach(item => {
                item.onclick = () => {
                    let parent = item.parentNode,
                        id     = parent.dataset.id;
                    data = data.filter(item => item.id != id);
                    renderFn();
                }
            });

            checkbox.forEach((item, index) =>{
                item.onchange = function() {
                    data[index].checked = this.checked;
                    renderFn();
                }
            });
        };

        renderFn();

        let addFn = () => {
            let name = nameInput.value, num = numInput.value;
            if (!name.trim()) {
                alert('名称不能为空');
                return;
            }
            if (!num.trim() || isNaN(num)) {
                alert('数量不符合规范');
                return;
            }
            data.push({
                id: new Date().getTime(),
                txt: name,
                num,
                liked: false,
                checked: false
            });
            renderFn();
            nameInput.value = '';
            numInput.value = null;
        };
        addBtn.onclick = addFn;

        let delCheckedFn = () => {
            data = data.filter(item => !item.checked);
            renderFn();
        };
        delBtn.onclick = delCheckedFn;

        checkAll.onchange = function () {
            data.forEach(item => {item.checked = this.checked});
            renderFn();
        };

        filter.forEach((item, index) => {
            item.onclick = () => {
                likeState = index;
                renderFn();
            }
        });

        sort.forEach((item, index) => {
            item.onclick = () => {
                sortState = index;
                renderFn();
            }
        });
    }
</script>
</body>
</html>